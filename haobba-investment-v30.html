<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÌïòÏò§Îπ† Ìà¨ÏûêÌÅ¥ÎüΩ V3.2 - Î¨¥Î£å Ïã§ÏãúÍ∞Ñ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: rgba(52, 152, 219, 0.3);
            touch-action: manipulation;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
            background: #F5F7FA;
            color: #1A2332;
            font-size: 15px;
            line-height: 1.5;
            overscroll-behavior: none;
        }

        .container {
            max-width: 100%;
            min-height: 100vh;
            background: #F5F7FA;
        }

        /* Ìó§Îçî */
        .header {
            background: linear-gradient(135deg, #2C3E50 0%, #3498DB 100%);
            color: white;
            padding: 20px 16px 16px 16px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: relative;
        }

        .header h1 {
            font-size: 22px;
            margin-bottom: 6px;
            font-weight: 700;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.95;
        }

        .header .version {
            font-size: 11px;
            opacity: 0.8;
            margin-top: 4px;
        }

        .header .data-status {
            font-size: 10px;
            opacity: 0.8;
            margin-top: 6px;
        }

        .status-live { background: #2ECC71; }
        .status-static { background: #F39C12; }

        .refresh-btn {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            user-select: none;
        }

        /* Í≥µÌè¨ÌÉêÏöï */
        .fear-greed-fixed {
            position: sticky;
            top: 0;
            z-index: 100;
            background: white;
            padding: 12px 16px;
            border-bottom: 2px solid #E8EBF3;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .fear-greed-title {
            font-size: 13px;
            font-weight: 700;
            color: #4A5B75;
            margin-bottom: 8px;
            text-align: center;
        }

        .fear-greed-bar {
            position: relative;
            height: 50px;
            background: linear-gradient(to right, #E74C3C 0%, #F39C12 25%, #27AE60 50%, #F39C12 75%, #E74C3C 100%);
            border-radius: 10px;
            border: 2px solid #BDC3C7;
            margin-bottom: 8px;
        }

        .fear-greed-pointer {
            position: absolute;
            width: 3px;
            height: 100%;
            background: #1A2332;
            border-radius: 2px;
            transition: left 0.5s ease;
        }

        .fear-greed-value {
            position: absolute;
            width: 100%;
            top: 50%;
            transform: translateY(-50%);
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
        }

        .fear-greed-action {
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            padding: 8px;
            border-radius: 6px;
        }

        .action-buy { background: #D4EDDA; color: #155724; }
        .action-hold { background: #FFF3CD; color: #856404; }
        .action-sell { background: #F8D7DA; color: #721C24; }

        /* ÌÉ≠ */
        .tabs-container {
            background: white;
            border-bottom: 2px solid #E8EBF3;
            overflow-x: auto;
            position: sticky;
            top: 97px;
            z-index: 99;
        }

        .tabs-scroll {
            display: flex;
            padding: 8px;
            gap: 6px;
        }

        .tab {
            flex: 0 0 auto;
            padding: 10px 14px;
            background: #F8F9FC;
            border: 2px solid #E8EBF3;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: #4A5B75;
            min-height: 44px;
            user-select: none;
        }

        .tab.active {
            background: linear-gradient(135deg, #3498DB 0%, #5DADE2 100%);
            color: white;
            border-color: #2980B9;
        }

        /* ÏÑπÏÖò */
        .section {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .section-title {
            font-size: 17px;
            font-weight: 700;
            color: #2C3E50;
            margin-bottom: 14px;
            padding-bottom: 10px;
            border-bottom: 2px solid #E8EBF3;
        }

        /* Ïª®ÌÖêÏ∏† */
        .content-area {
            padding: 12px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Î≤ÑÌäº */
        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #3498DB 0%, #5DADE2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            min-height: 48px;
            user-select: none;
        }

        .btn:active {
            transform: scale(0.98);
        }

        /* Ïù∏Ìè¨Î∞ïÏä§ */
        .info-box {
            background: #FFF9E6;
            border: 2px solid #F39C12;
            border-left: 5px solid #F39C12;
            border-radius: 8px;
            padding: 14px;
            margin: 12px 0;
        }

        .info-title {
            font-size: 14px;
            font-weight: 700;
            color: #E67E22;
            margin-bottom: 8px;
        }

        .info-content {
            font-size: 13px;
            line-height: 1.6;
            color: #7F8C8D;
        }

        .success-box {
            background: #D4EDDA;
            border-color: #28A745;
        }

        .success-box .info-title {
            color: #155724;
        }

        .warning-box {
            background: #FFE8E8;
            border-color: #E74C3C;
        }

        .warning-box .info-title {
            color: #C0392B;
        }

        /* API ÏÉÅÌÉú */
        .api-status {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            border: 2px solid #E8EBF3;
        }

        .api-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #F8F9FC;
        }

        .api-item:last-child {
            border-bottom: none;
        }

        .api-label {
            font-size: 13px;
            font-weight: 600;
            color: #2C3E50;
        }

        .api-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }

        .badge-connected {
            background: #D4EDDA;
            color: #155724;
        }

        .badge-pending {
            background: #FFF3CD;
            color: #856404;
        }

        .badge-error {
            background: #F8D7DA;
            color: #721C24;
        }

        @media (min-width: 768px) {
            .container {
                max-width: 800px;
                margin: 0 auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Ìó§Îçî -->
        <div class="header">
            <button class="refresh-btn" onclick="refreshAllData()">üîÑ ÏÉàÎ°úÍ≥†Ïπ®</button>
            <h1>üíº ÌïòÏò§Îπ† Ìà¨ÏûêÌÅ¥ÎüΩ</h1>
            <p class="subtitle">ÏÜêÏ£ºÎ∂Ä Ìà¨ÏûêÎ≤ï + Î¨¥Î£å Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞</p>
            <p class="version">V3.2 - Free Real-time Edition</p>
            <p class="data-status" id="dataStatus">
                API Ïó∞Í≤∞ ÌôïÏù∏ Ï§ë...
            </p>
        </div>

        <!-- Í≥µÌè¨ÌÉêÏöï ÏßÄÏàò -->
        <div class="fear-greed-fixed">
            <div class="fear-greed-title" id="fgTitle">
                üò± Í≥µÌè¨ÏôÄ ÌÉêÏöï ÏßÄÏàò
            </div>
            <div class="fear-greed-bar">
                <div id="fearGreedPointer" class="fear-greed-pointer" style="left: 50%;"></div>
                <div class="fear-greed-value" id="fearGreedValue">--</div>
            </div>
            <div id="fearGreedAction" class="fear-greed-action action-hold">
                Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...
            </div>
        </div>

        <!-- ÌÉ≠ -->
        <div class="tabs-container">
            <div class="tabs-scroll">
                <div class="tab active" onclick="switchTab(event, 'setup')">‚öôÔ∏è ÏÑ§Ï†ï</div>
                <div class="tab" onclick="switchTab(event, 'main')">üèÜ Ìà¨ÏûêÎ≤ï</div>
                <div class="tab" onclick="switchTab(event, 'screener')">üéØ Ïä§ÌÅ¨Î¶¨ÎÑà</div>
            </div>
        </div>

        <!-- Ïª®ÌÖêÏ∏† -->
        <div class="content-area">
            
            <!-- ‚öôÔ∏è ÏÑ§Ï†ï -->
            <div id="tab-setup" class="tab-content active">
                <div class="section">
                    <div class="section-title">‚öôÔ∏è API ÏÑ§Ï†ï</div>
                    
                    <div class="warning-box">
                        <div class="info-title">üö® Ï§ëÏöî: API URL ÏûÖÎ†• ÌïÑÏàò!</div>
                        <div class="info-content">
                            Î¨¥Î£å Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞Î•º ÏÇ¨Ïö©ÌïòÎ†§Î©¥ Î®ºÏ†Ä Î∞±ÏóîÎìú ÏÑúÎ≤ÑÎ•º Î∞∞Ìè¨ÌïòÍ≥†<br>
                            ÏïÑÎûòÏóê URLÏùÑ ÏûÖÎ†•Ìï¥Ïïº Ìï©ÎãàÎã§.
                        </div>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <label style="font-size: 14px; font-weight: 600; color: #4A5B75; display: block; margin-bottom: 6px;">
                            üåê Vercel API URL
                        </label>
                        <input type="text" id="apiUrlInput" 
                               style="width: 100%; padding: 12px; border: 2px solid #E8EBF3; border-radius: 8px; font-size: 14px;"
                               placeholder="https://haobba-api-xxx.vercel.app"
                               value="">
                        <p style="font-size: 11px; color: #7F8C8D; margin-top: 4px;">
                            ÏòàÏãú: https://haobba-api-abc123.vercel.app
                        </p>
                    </div>

                    <button class="btn" onclick="saveApiUrl()">
                        üíæ Ï†ÄÏû• Î∞è Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
                    </button>
                </div>

                <div class="section">
                    <div class="section-title">üìä API Ïó∞Í≤∞ ÏÉÅÌÉú</div>
                    
                    <div class="api-status">
                        <div class="api-item">
                            <span class="api-label">Í≥µÌè¨ÌÉêÏöï ÏßÄÏàò</span>
                            <span id="fgApiStatus" class="api-badge badge-pending">ÎåÄÍ∏∞Ï§ë</span>
                        </div>
                        <div class="api-item">
                            <span class="api-label">Ï¢ÖÎ™© Îç∞Ïù¥ÌÑ∞ (NVDA)</span>
                            <span id="stockApiStatus" class="api-badge badge-pending">ÎåÄÍ∏∞Ï§ë</span>
                        </div>
                        <div class="api-item">
                            <span class="api-label">Ïò§Îäò API ÏÇ¨Ïö©</span>
                            <span id="apiUsage" class="api-badge badge-pending">0/500</span>
                        </div>
                    </div>
                </div>

                <div class="info-box">
                    <div class="info-title">üìö Î∞±ÏóîÎìú ÏÑúÎ≤Ñ ÎßåÎì§Í∏∞ (10Î∂Ñ)</div>
                    <div class="info-content">
                        <strong>Step 1:</strong> GitHubÏóê haobba-api Ï†ÄÏû•ÏÜå ÏÉùÏÑ±<br>
                        <strong>Step 2:</strong> 5Í∞ú ÌååÏùº ÏóÖÎ°úÎìú (ÏΩîÎìú Ï†úÍ≥µÎê®)<br>
                        <strong>Step 3:</strong> VercelÏóêÏÑú Î∞∞Ìè¨ (Î¨¥Î£å)<br>
                        <strong>Step 4:</strong> URLÏùÑ ÏúÑÏóê ÏûÖÎ†•<br>
                        <br>
                        <strong style="color: #27AE60;">‚úÖ ÏôÑÏ†Ñ Î¨¥Î£å (500Ìöå/Ïùº)</strong>
                    </div>
                </div>
            </div>

            <!-- üèÜ Ìà¨ÏûêÎ≤ï -->
            <div id="tab-main" class="tab-content">
                <div class="section">
                    <div class="section-title">üèÜ ÏÜêÏ£ºÎ∂Ä Ìà¨ÏûêÎ≤ï</div>
                    
                    <div class="success-box">
                        <div class="info-title">‚úÖ Ïù¥Ï†ú Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ ÏßÄÏõê!</div>
                        <div class="info-content">
                            ‚Ä¢ Í≥µÌè¨ÌÉêÏöï ÏßÄÏàò: Ïã§ÏãúÍ∞Ñ (10Î∂ÑÎßàÎã§ ÏûêÎèô)<br>
                            ‚Ä¢ Ï£ºÏöî Ï¢ÖÎ™© PEG/ROE: Ïã§ÏãúÍ∞Ñ (ÌïòÎ£® 2Ìöå)<br>
                            ‚Ä¢ ÏôÑÏ†Ñ Î¨¥Î£å (Alpha Vantage 500Ìöå/Ïùº)
                        </div>
                    </div>

                    <div class="info-box">
                        <div class="info-title">üéØ Ìà¨Ïûê 3ÏõêÏπô</div>
                        <div class="info-content">
                            <strong>1. Ïãº Í≤ÉÏùÑ ÏÇ¨Îùº</strong> - PEG < 1.0<br>
                            <strong>2. Ï¢ãÏùÄ Í∏∞ÏóÖ Î≥¥Ïú†</strong> - ROE > 15%<br>
                            <strong>3. Í≥µÌè¨Ìï† Îïå Îß§Ïàò</strong> - ÏßÄÏàò 25 Ïù¥Ìïò
                        </div>
                    </div>
                </div>
            </div>

            <!-- üéØ Ïä§ÌÅ¨Î¶¨ÎÑà -->
            <div id="tab-screener" class="tab-content">
                <div class="section">
                    <div class="section-title">üéØ Ïã§ÏãúÍ∞Ñ Ïä§ÌÅ¨Î¶¨ÎÑà</div>
                    
                    <div class="info-box">
                        <div class="info-title">üîÑ Îç∞Ïù¥ÌÑ∞ Í∞±Ïã† Ï†ÑÎûµ</div>
                        <div class="info-content">
                            <strong>Ï£ºÏöî 20Í∞ú Ï¢ÖÎ™©</strong> - ÌïòÎ£® 2Ìöå ÏûêÎèô Í∞±Ïã†<br>
                            <strong>ÎÇòÎ®∏ÏßÄ 180Í∞ú</strong> - Ï†ïÏ†Å Îç∞Ïù¥ÌÑ∞ (2025.01.15)<br>
                            <strong>Î¨¥Î£å Ï†úÌïú</strong> - 500Ìöå/Ïùº (Ï∂©Î∂ÑÌï®!)
                        </div>
                    </div>

                    <button class="btn" onclick="updateTopStocks()">
                        üìä Ï£ºÏöî Ï¢ÖÎ™© ÏßÄÍ∏à Í∞±Ïã†ÌïòÍ∏∞
                    </button>

                    <div id="stockResults" style="margin-top: 12px;">
                        <!-- Í≤∞Í≥º ÌëúÏãú -->
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // === Í∏ÄÎ°úÎ≤å ÏÑ§Ï†ï ===
        let API_URL = localStorage.getItem('apiUrl') || '';
        let apiCallCount = parseInt(localStorage.getItem('apiCallCount') || '0');
        let lastResetDate = localStorage.getItem('lastResetDate') || new Date().toDateString();

        // ÎÇ†ÏßúÍ∞Ä Î∞îÎÄåÎ©¥ Ïπ¥Ïö¥Ìä∏ Î¶¨ÏÖã
        if (lastResetDate !== new Date().toDateString()) {
            apiCallCount = 0;
            localStorage.setItem('apiCallCount', '0');
            localStorage.setItem('lastResetDate', new Date().toDateString());
        }

        // Ï£ºÏöî Ï¢ÖÎ™© 20Í∞ú (Ïã§ÏãúÍ∞Ñ Í∞±Ïã†)
        const TOP_STOCKS = [
            'NVDA', 'META', 'GOOGL', 'MSFT', 'AAPL',
            'AMZN', 'TSLA', 'AMD', 'TSM', 'AVGO',
            'CRM', 'ORCL', 'JPM', 'V', 'MA',
            'WMT', 'COST', 'JNJ', 'UNH', 'PFE'
        ];

        // === API URL Ï†ÄÏû• ===
        function saveApiUrl() {
            const url = document.getElementById('apiUrlInput').value.trim();
            
            if (!url) {
                alert('‚ùå URLÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }

            if (!url.startsWith('http')) {
                alert('‚ùå https://Î°ú ÏãúÏûëÌïòÎäî URLÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }

            API_URL = url.replace(/\/$/, ''); // ÎÅùÏùò / Ï†úÍ±∞
            localStorage.setItem('apiUrl', API_URL);
            
            alert('‚úÖ API URLÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!\nÏó∞Í≤∞ ÌÖåÏä§Ìä∏Î•º ÏãúÏûëÌï©ÎãàÎã§...');
            
            testApiConnection();
        }

        // === API Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ ===
        async function testApiConnection() {
            // Í≥µÌè¨ÌÉêÏöï ÌÖåÏä§Ìä∏
            try {
                document.getElementById('fgApiStatus').textContent = 'ÌÖåÏä§Ìä∏Ï§ë...';
                document.getElementById('fgApiStatus').className = 'api-badge badge-pending';
                
                const response = await fetch(`${API_URL}/api/feargreed`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('fgApiStatus').textContent = '‚úÖ Ïó∞Í≤∞Îê®';
                    document.getElementById('fgApiStatus').className = 'api-badge badge-connected';
                    
                    // Í≥µÌè¨ÌÉêÏöï ÏßÄÏàò ÏóÖÎç∞Ïù¥Ìä∏
                    updateFearGreed(parseInt(data.data.value));
                    
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                document.getElementById('fgApiStatus').textContent = '‚ùå Ïã§Ìå®';
                document.getElementById('fgApiStatus').className = 'api-badge badge-error';
                console.error('Í≥µÌè¨ÌÉêÏöï API Ïò§Î•ò:', error);
            }

            // Ï¢ÖÎ™© Îç∞Ïù¥ÌÑ∞ ÌÖåÏä§Ìä∏
            try {
                document.getElementById('stockApiStatus').textContent = 'ÌÖåÏä§Ìä∏Ï§ë...';
                
                const response = await fetch(`${API_URL}/api/stock?ticker=NVDA`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('stockApiStatus').textContent = '‚úÖ Ïó∞Í≤∞Îê®';
                    document.getElementById('stockApiStatus').className = 'api-badge badge-connected';
                    
                    incrementApiCall();
                    
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                document.getElementById('stockApiStatus').textContent = '‚ùå Ïã§Ìå®';
                document.getElementById('stockApiStatus').className = 'api-badge badge-error';
                console.error('Ï¢ÖÎ™© Îç∞Ïù¥ÌÑ∞ API Ïò§Î•ò:', error);
            }

            updateDataStatus();
        }

        // === API Ìò∏Ï∂ú Ïπ¥Ïö¥Ìä∏ ===
        function incrementApiCall() {
            apiCallCount++;
            localStorage.setItem('apiCallCount', apiCallCount.toString());
            document.getElementById('apiUsage').textContent = `${apiCallCount}/500`;
            
            if (apiCallCount >= 500) {
                document.getElementById('apiUsage').className = 'api-badge badge-error';
                alert('‚ö†Ô∏è Ïò§ÎäòÏùò API Ìï†ÎãπÎüâÏùÑ Î™®Îëê ÏÇ¨Ïö©ÌñàÏäµÎãàÎã§!\nÎÇ¥Ïùº Îã§Ïãú ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§.');
            } else if (apiCallCount >= 400) {
                document.getElementById('apiUsage').className = 'api-badge badge-pending';
            } else {
                document.getElementById('apiUsage').className = 'api-badge badge-connected';
            }
        }

        // === Í≥µÌè¨ÌÉêÏöï ÏßÄÏàò ===
        async function fetchFearGreedIndex() {
            if (!API_URL) {
                console.log('‚ö†Ô∏è API URLÏù¥ ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/feargreed`);
                const result = await response.json();
                
                if (result.success) {
                    const value = parseInt(result.data.value);
                    updateFearGreed(value);
                    
                    document.getElementById('fgTitle').innerHTML = `
                        üò± Í≥µÌè¨ÏôÄ ÌÉêÏöï ÏßÄÏàò <span style="color: #2ECC71; font-size: 11px;">‚óè Ïã§ÏãúÍ∞Ñ</span>
                    `;
                    
                    console.log('‚úÖ Í≥µÌè¨ÌÉêÏöï ÏßÄÏàò Í∞±Ïã†:', value);
                }
            } catch (error) {
                console.error('‚ùå Í≥µÌè¨ÌÉêÏöï API Ïò§Î•ò:', error);
            }
        }

        function updateFearGreed(value) {
            document.getElementById('fearGreedValue').textContent = value;
            document.getElementById('fearGreedPointer').style.left = value + '%';
            
            const actionBox = document.getElementById('fearGreedAction');
            if (value <= 25) {
                actionBox.className = 'fear-greed-action action-buy';
                actionBox.textContent = 'üü¢ Í∞ïÎ†• Îß§Ïàò! (Í∑πÍ≥µÌè¨ - 70-80% ÎπÑÏ§ë)';
            } else if (value <= 45) {
                actionBox.className = 'fear-greed-action action-buy';
                actionBox.textContent = 'üü¢ Îß§Ïàò ÌÉÄÏù¥Î∞ç! (Í≥µÌè¨ - 50-70% ÎπÑÏ§ë)';
            } else if (value <= 55) {
                actionBox.className = 'fear-greed-action action-hold';
                actionBox.textContent = 'üü° Ï§ëÎ¶Ω (Í¥ÄÎßù - 30-50% ÎπÑÏ§ë)';
            } else if (value <= 75) {
                actionBox.className = 'fear-greed-action action-hold';
                actionBox.textContent = 'üü° Ï£ºÏùò (ÌÉêÏöï - 20-30% ÎπÑÏ§ë)';
            } else {
                actionBox.className = 'fear-greed-action action-sell';
                actionBox.textContent = 'üî¥ Îß§ÎèÑ! (Í∑πÌÉêÏöï - Ï∞®ÏùµÏã§ÌòÑ)';
            }
        }

        // === Ï£ºÏöî Ï¢ÖÎ™© Í∞±Ïã† ===
        async function updateTopStocks() {
            if (!API_URL) {
                alert('‚ö†Ô∏è Î®ºÏ†Ä ÏÑ§Ï†ï ÌÉ≠ÏóêÏÑú API URLÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                switchTab(null, 'setup');
                return;
            }

            if (apiCallCount >= 500) {
                alert('‚ùå Ïò§ÎäòÏùò API Ìï†ÎãπÎüâÏùÑ Î™®Îëê ÏÇ¨Ïö©ÌñàÏäµÎãàÎã§!');
                return;
            }

            const resultsDiv = document.getElementById('stockResults');
            resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #7F8C8D;">Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Îäî Ï§ë...</div>';

            let results = [];
            let successCount = 0;

            for (let i = 0; i < Math.min(TOP_STOCKS.length, 500 - apiCallCount); i++) {
                const ticker = TOP_STOCKS[i];
                
                try {
                    const response = await fetch(`${API_URL}/api/stock?ticker=${ticker}`);
                    const data = await response.json();
                    
                    if (data.success && data.data.peg) {
                        results.push(data.data);
                        successCount++;
                        incrementApiCall();
                        
                        // ÏßÑÌñâ ÏÉÅÌô© ÌëúÏãú
                        resultsDiv.innerHTML = `<div style="text-align: center; padding: 20px; color: #7F8C8D;">
                            ${successCount}/${TOP_STOCKS.length} ÏôÑÎ£å...
                        </div>`;
                        
                        // Í≥ºÎèÑÌïú API Ìò∏Ï∂ú Î∞©ÏßÄ
                        await new Promise(resolve => setTimeout(resolve, 1000)); // 1Ï¥à ÎåÄÍ∏∞
                    }
                } catch (error) {
                    console.error(`${ticker} Ïò§Î•ò:`, error);
                }
            }

            // Í≤∞Í≥º ÌëúÏãú
            results.sort((a, b) => parseFloat(a.peg) - parseFloat(b.peg));
            
            resultsDiv.innerHTML = `
                <div class="success-box">
                    <div class="info-title">‚úÖ ${successCount}Í∞ú Ï¢ÖÎ™© Í∞±Ïã† ÏôÑÎ£å!</div>
                    <div class="info-content">
                        API ÏÇ¨Ïö©: ${apiCallCount}/500
                    </div>
                </div>
                <div style="margin-top: 12px;">
                    <strong>PEG ÏàúÏúÑ TOP 10:</strong>
                    ${results.slice(0, 10).map((stock, idx) => `
                        <div style="padding: 8px; background: white; border: 1px solid #E8EBF3; border-radius: 6px; margin-top: 6px;">
                            <strong>${idx + 1}. ${stock.ticker}</strong> - ${stock.name}<br>
                            <span style="font-size: 13px; color: #7F8C8D;">
                                PEG: <strong style="color: #27AE60;">${stock.peg}</strong> | 
                                ROE: ${stock.roe?.toFixed(1)}% | 
                                PER: ${stock.per?.toFixed(1)}
                            </span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // === ÏÉàÎ°úÍ≥†Ïπ® ===
        function refreshAllData() {
            if (!API_URL) {
                alert('‚ö†Ô∏è Î®ºÏ†Ä API URLÏùÑ ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî!');
                switchTab(null, 'setup');
                return;
            }

            fetchFearGreedIndex();
            alert('‚úÖ Í≥µÌè¨ÌÉêÏöï ÏßÄÏàò Í∞±Ïã† ÏôÑÎ£å!');
        }

        // === ÌÉ≠ Ï†ÑÌôò ===
        function switchTab(e, tabName) {
            if (e) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
            }
            
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // === ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ ===
        function updateDataStatus() {
            const status = document.getElementById('dataStatus');
            if (API_URL) {
                status.innerHTML = `‚úÖ API Ïó∞Í≤∞Îê® | ÏÇ¨Ïö©: ${apiCallCount}/500`;
            } else {
                status.innerHTML = `‚ö†Ô∏è API URL ÏÑ§Ï†ï ÌïÑÏöî (ÏÑ§Ï†ï ÌÉ≠)`;
            }
        }

        // === Ï¥àÍ∏∞Ìôî ===
        document.addEventListener('DOMContentLoaded', () => {
            // API URL Î≥µÏõê
            if (API_URL) {
                document.getElementById('apiUrlInput').value = API_URL;
                testApiConnection();
                
                // 10Î∂ÑÎßàÎã§ Í≥µÌè¨ÌÉêÏöï ÏûêÎèô Í∞±Ïã†
                setInterval(fetchFearGreedIndex, 10 * 60 * 1000);
            }

            updateDataStatus();
            document.getElementById('apiUsage').textContent = `${apiCallCount}/500`;

            console.log('üöÄ ÌïòÏò§Îπ† Ìà¨ÏûêÌÅ¥ÎüΩ V3.2 ÏãúÏûë');
            console.log('üìä API URL:', API_URL || 'ÎØ∏ÏÑ§Ï†ï');
            console.log('üìà Ïò§Îäò ÏÇ¨Ïö©Îüâ:', apiCallCount, '/500');
        });
    </script>
</body>
</html>